name: Monthly Extrato Backup Safety Net

permissions:
  issues: write

on:
  # Schedule: 1st of each month at 03:00 UTC
  # (APScheduler runs on 1st at 02:00 São Paulo = 05:00 UTC)
  schedule:
    - cron: '0 3 1 * *'
  
  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      month:
        description: 'Month (1-12, leave empty for previous month)'
        required: false
        type: number
      year:
        description: 'Year (YYYY, leave empty for previous month)'
        required: false
        type: number
      force:
        description: 'Force generation (ignore threshold)'
        required: false
        type: boolean
        default: false

jobs:
  trigger-extrato-generation:
    name: Trigger Monthly Extrato Generation
    runs-on: ubuntu-latest
    
    # Note: This workflow requires two GitHub Secrets:
    # - EXTRATO_API_BASE_URL: Base URL of your backend API (e.g., https://api.yourdomain.com)
    # - EXTRATO_API_TOKEN: Long-lived service account JWT token with admin role
    #   (NOT a regular user JWT - create a dedicated service account for automation)
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github
      
      - name: Set up environment
        id: setup
        run: |
          # Calculate previous month if not provided
          if [ -z "${{ github.event.inputs.month }}" ]; then
            MONTH=$(date -d "last month" +%-m)
            YEAR=$(date -d "last month" +%Y)
          else
            MONTH=${{ github.event.inputs.month }}
            YEAR=${{ github.event.inputs.year }}
          fi
          
          echo "month=$MONTH" >> $GITHUB_OUTPUT
          echo "year=$YEAR" >> $GITHUB_OUTPUT
          echo "force=${{ github.event.inputs.force || 'false' }}" >> $GITHUB_OUTPUT
          
          echo "Target: $MONTH/$YEAR"
          echo "Force: ${{ github.event.inputs.force || 'false' }}"
      
      - name: Create backup
        id: backup
        env:
          API_BASE_URL: ${{ secrets.EXTRATO_API_BASE_URL }}
          API_TOKEN: ${{ secrets.EXTRATO_API_TOKEN }}
          MONTH: ${{ steps.setup.outputs.month }}
          YEAR: ${{ steps.setup.outputs.year }}
        run: |
          set -e  # Exit on any error
          
          # Validate required secrets exist
          if [ -z "$API_BASE_URL" ] || [ -z "$API_TOKEN" ]; then
            echo "ERROR: EXTRATO_API_BASE_URL or EXTRATO_API_TOKEN not configured"
            echo "Add these secrets in: Settings → Secrets and variables → Actions"
            exit 1
          fi
          
          echo "Backup Step Starting..."
          echo "   Target: $MONTH/$YEAR"
          
          # Build JSON payload for backup creation
          PAYLOAD=$(jq -n \
            --arg month "$MONTH" \
            --arg year "$YEAR" \
            '{month: ($month|tonumber), year: ($year|tonumber)}' )
          
          echo "Endpoint: $API_BASE_URL/api/backup/create_service"
          echo "Payload: $PAYLOAD"
          
          # Make backup creation request with timeout
          echo "Sending backup creation request..."
          HTTP_RESPONSE=$(curl -s -w "\n%{http_code}" \
            --connect-timeout 10 \
            --max-time 60 \
            -X POST \
            "$API_BASE_URL/api/backup/create_service" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $API_TOKEN" \
            -d "$PAYLOAD")
          
          # Extract HTTP status code and body
          HTTP_BODY=$(echo "$HTTP_RESPONSE" | head -n -1)
          HTTP_STATUS=$(echo "$HTTP_RESPONSE" | tail -n 1)
          
          echo "Response Status: $HTTP_STATUS"
          echo "Response Body:"
          echo "$HTTP_BODY" | jq . 2>/dev/null || echo "$HTTP_BODY"
          
          # Save response for debugging
          echo "$HTTP_BODY" > backup_response.json
          
          # Parse response
          RESPONSE_SUCCESS=$(echo "$HTTP_BODY" | jq -r '.success // false' 2>/dev/null)
          RESPONSE_MESSAGE=$(echo "$HTTP_BODY" | jq -r '.message // .error // "Unknown response"' 2>/dev/null)
          
          echo ""
          echo "Parsed Response:"
          echo "   Success: $RESPONSE_SUCCESS"
          echo "   Message: $RESPONSE_MESSAGE"
          echo ""
          
          # Evaluate backup outcome based on both status code and response body
          if [ "$HTTP_STATUS" -eq 200 ] && [ "$RESPONSE_SUCCESS" = "true" ]; then
            # Check the message to see if this was "no data to backup"
            if echo "$RESPONSE_MESSAGE" | grep -i "no data\|no historical data" > /dev/null; then
              echo "WARNING: No data to backup - extrato generation will be skipped"
              echo "   Reason: No payment/session data found for $MONTH/$YEAR"
              echo "   File created: No (no data available)"
              echo "backup_status=no_data" >> $GITHUB_OUTPUT
              exit 0
            else
              # Backup was successfully created
              echo "SUCCESS: Backup created successfully for $MONTH/$YEAR"
              echo "backup_status=created" >> $GITHUB_OUTPUT
              echo "backup_existed=false" >> $GITHUB_OUTPUT
              exit 0
            fi
            
          elif [ "$HTTP_STATUS" -eq 409 ]; then
            # Backup already exists (conflict) - this is acceptable
            echo "INFO: Backup already exists for $MONTH/$YEAR"
            echo "backup_status=already_exists" >> $GITHUB_OUTPUT
            echo "backup_existed=true" >> $GITHUB_OUTPUT
            exit 0
            
          elif [ "$HTTP_STATUS" -eq 200 ] && [ "$RESPONSE_SUCCESS" = "false" ]; then
            # 200 but success=false - something went wrong
            echo "WARNING: API returned 200 but success=false"
            echo "   Message: $RESPONSE_MESSAGE"
            echo "backup_status=partial_failure" >> $GITHUB_OUTPUT
            exit 0  # Continue - might be "no data to backup"
            
          else
            # Actual error
            echo "FAILED: Backup creation failed with HTTP $HTTP_STATUS"
            echo "   Message: $RESPONSE_MESSAGE"
            echo "backup_status=error" >> $GITHUB_OUTPUT
            echo ""
            echo "Debugging Information:"
            echo "   Endpoint: $API_BASE_URL/api/backup/create_service"
            echo "   HTTP Status: $HTTP_STATUS"
            echo "   Tokens/Secrets: Check GitHub Actions secrets are correctly set"
            echo "   Network: Check if API is reachable from GitHub Actions runner"
            echo ""
            exit 1  # Explicit failure
          fi
      
      - name: Trigger extrato generation endpoint
        id: trigger
        env:
          API_BASE_URL: ${{ secrets.EXTRATO_API_BASE_URL }}
          API_TOKEN: ${{ secrets.EXTRATO_API_TOKEN }}
          MONTH: ${{ steps.setup.outputs.month }}
          YEAR: ${{ steps.setup.outputs.year }}
          FORCE: ${{ steps.setup.outputs.force }}
          BACKUP_STATUS: ${{ steps.backup.outputs.backup_status }}
          EXTRATO_REQUIRE_BACKUP: "false"
        run: |
          set +e  # Don't exit on error - we handle it manually
          
          # Check if backup step reported "no_data" - if so, skip extrato generation
          if [ "$BACKUP_STATUS" == "no_data" ]; then
            echo "Skipping extrato generation: No data available for backup for $MONTH/$YEAR"
            echo "This is normal when there are no payments/sessions in the database for this period"
            echo "status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Validate required secrets exist
          if [ -z "$API_BASE_URL" ] || [ -z "$API_TOKEN" ]; then
            echo "ERROR: EXTRATO_API_BASE_URL or EXTRATO_API_TOKEN not configured"
            echo "Add these secrets in: Settings → Secrets and variables → Actions"
            exit 1
          fi
          
          echo "Extrato Generation Step Starting..."
          echo "   Target: $MONTH/$YEAR (Force: $FORCE)"
          echo "   Backup Status from previous step: $BACKUP_STATUS"
          echo "   Backup Requirement: DISABLED (for GitHub Actions automation)"
          
          # Build strict JSON payload using jq (forces numeric month/year and boolean force)
          PAYLOAD=$(jq -n \
            --arg month "$MONTH" \
            --arg year "$YEAR" \
            --arg force "$FORCE" \
            '{month: ($month|tonumber), year: ($year|tonumber), force: ($force=="true") }' )
          
          echo "Target endpoint: $API_BASE_URL/api/extrato/generate_service"
          echo "Payload: $PAYLOAD"
          echo ""
          
          # Retry configuration
          MAX_RETRIES=3
          DELAY=5
          SUCCESS=false
          
          # Make API request with retry logic
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i of $MAX_RETRIES..."
            
            HTTP_RESPONSE=$(curl -s -w "\n%{http_code}" \
              --connect-timeout 10 \
              --max-time 60 \
              -X POST \
              "$API_BASE_URL/api/extrato/generate_service" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $API_TOKEN" \
              -d "$PAYLOAD")
            
            # Extract HTTP status code and body
            HTTP_BODY=$(echo "$HTTP_RESPONSE" | head -n -1)
            HTTP_STATUS=$(echo "$HTTP_RESPONSE" | tail -n 1)
            
            echo "   Status: $HTTP_STATUS"
            
            # Save response for debugging
            echo "$HTTP_BODY" > response.json
            
            # Parse response details
            RESPONSE_SUCCESS=$(echo "$HTTP_BODY" | jq -r '.success // false' 2>/dev/null)
            RESPONSE_ERROR=$(echo "$HTTP_BODY" | jq -r '.error // .message // ""' 2>/dev/null)
            RESPONSE_DETAILS=$(echo "$HTTP_BODY" | jq -r '.details // ""' 2>/dev/null)
            
            echo "   Response:"
            echo "$HTTP_BODY" | jq . 2>/dev/null || echo "   (raw) $HTTP_BODY"
            
            # Check for backup verification failure
            BACKUP_FAILURE=false
            if echo "$RESPONSE_ERROR" | grep -q "backup verification failed"; then
              BACKUP_FAILURE=true
              echo ""
              echo "BACKUP VERIFICATION FAILURE DETECTED"
              echo "   Error: $RESPONSE_ERROR"
              echo "   This likely means: Backup step did not create the required backup file"
            fi
            
            # Check if request was successful
            if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
              echo "SUCCESS: Extrato generation completed"
              echo "status=$HTTP_STATUS" >> $GITHUB_OUTPUT
              SUCCESS=true
              break
              
            elif [ "$HTTP_STATUS" -eq 500 ] && [ "$RESPONSE_DETAILS" = "Extrato already exists for month/year" ]; then
              echo "INFO: Extrato already exists for $MONTH/$YEAR (no regeneration needed)"
              echo "status=$HTTP_STATUS" >> $GITHUB_OUTPUT
              SUCCESS=true
              break
              
            elif [ "$BACKUP_FAILURE" = "true" ]; then
              # Backup verification failure - don't retry, this needs to be fixed
              echo ""
              echo "FAILED: Backup verification failed"
              echo "   Backup status from step: $BACKUP_STATUS"
              echo "   Action required: Ensure backup was created successfully"
              echo ""
              echo "status=$HTTP_STATUS" >> $GITHUB_OUTPUT
              break  # Don't retry - this is a configuration issue
              
            elif [ "$i" -lt $MAX_RETRIES ]; then
              echo "   Retrying in $DELAY seconds (attempt $((i+1))/$MAX_RETRIES)..."
              sleep $DELAY
              DELAY=$((DELAY * 2))  # Exponential backoff
              
            else
              echo "FAILED: All $MAX_RETRIES attempts exhausted"
              echo "status=$HTTP_STATUS" >> $GITHUB_OUTPUT
            fi
          done
          
          if [ "$SUCCESS" = "false" ]; then
            exit 1
          fi
      
      - name: Upload debug responses on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: extrato-api-responses
          path: |
            response.json
            backup_response.json
          retention-days: 7
      
      - name: Parse response
        id: parse
        if: success()
        run: |
          # Extract key fields from response
          SUCCESS=$(jq -r '.success // false' response.json)
          MESSAGE=$(jq -r '.message // "No message"' response.json)
          EXTRATO_ID=$(jq -r '.extrato_id // "N/A"' response.json)
          
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "message=$MESSAGE" >> $GITHUB_OUTPUT
          echo "extrato_id=$EXTRATO_ID" >> $GITHUB_OUTPUT
          
          echo "Success: $SUCCESS"
          echo "Message: $MESSAGE"
          echo "Extrato ID: $EXTRATO_ID"
      
      - name: Create summary
        if: always()
        run: |
          echo "## Monthly Extrato Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Target Period**: ${{ steps.setup.outputs.month }}/${{ steps.setup.outputs.year }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger Type**: ${{ github.event_name == 'schedule' && 'Scheduled' || 'Manual' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Backup Requirement**: Disabled (EXTRATO_REQUIRE_BACKUP=false for GitHub Actions)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Backup step status
          echo "### Step 1: Backup Creation" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.backup.outcome }}" == "success" ]; then
            BACKUP_STATUS="${{ steps.backup.outputs.backup_status }}"
            if [ "$BACKUP_STATUS" = "created" ]; then
              echo "- Status: Backup created successfully" >> $GITHUB_STEP_SUMMARY
            elif [ "$BACKUP_STATUS" = "already_exists" ]; then
              echo "- Status: Backup already exists (reused)" >> $GITHUB_STEP_SUMMARY
            elif [ "$BACKUP_STATUS" = "no_data" ]; then
              echo "- Status: No data available for backup" >> $GITHUB_STEP_SUMMARY
              echo "  - Note: No payments/sessions found for this period" >> $GITHUB_STEP_SUMMARY
              echo "  - Extrato generation will be skipped" >> $GITHUB_STEP_SUMMARY
            else
              echo "- Status: $BACKUP_STATUS" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- Status: Backup creation FAILED" >> $GITHUB_STEP_SUMMARY
            echo "  - **Output**: ${{ steps.backup.outputs.backup_status }}" >> $GITHUB_STEP_SUMMARY
            echo "  - **Details**: See logs for curl output and error response" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extrato generation step status
          echo "### Step 2: Extrato Generation" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.trigger.outputs.status }}" = "skipped" ]; then
            echo "- Status: Skipped (no data for backup)" >> $GITHUB_STEP_SUMMARY
            echo "  - Reason: No payments/sessions in database for ${{ steps.setup.outputs.month }}/${{ steps.setup.outputs.year }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.trigger.outcome }}" == "success" ]; then
            echo "- Status: Extrato generation completed" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.parse.outputs.success }}" == "true" ]; then
              echo "  - **Result**: Successfully generated" >> $GITHUB_STEP_SUMMARY
              echo "  - **Message**: ${{ steps.parse.outputs.message }}" >> $GITHUB_STEP_SUMMARY
              echo "  - **Extrato ID**: ${{ steps.parse.outputs.extrato_id }}" >> $GITHUB_STEP_SUMMARY
            else
              echo "  - **Result**: Already exists (no regeneration)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- Status: Extrato generation FAILED (HTTP ${{ steps.trigger.outputs.status }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Diagnostic Information:" >> $GITHUB_STEP_SUMMARY
            echo "- **HTTP Status**: \`${{ steps.trigger.outputs.status }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Backup Status (Previous Step)**: \`${{ steps.backup.outputs.backup_status }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Backup File Existence**: Unknown (check API response in artifacts)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Troubleshooting Guide:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**If backup verification failed:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Check if backup file was created: \`backups/${{ steps.setup.outputs.year }}_${{ steps.setup.outputs.month }}/backup_${{ steps.setup.outputs.year }}_${{ steps.setup.outputs.month }}.csv\`" >> $GITHUB_STEP_SUMMARY
            echo "2. Verify database has data for this period (check payment/session records)" >> $GITHUB_STEP_SUMMARY
            echo "3. Review backup creation response in \`extrato-api-responses\` artifact" >> $GITHUB_STEP_SUMMARY
            echo "4. Check database connectivity from API container" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**If API endpoint is unreachable:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Verify \`EXTRATO_API_BASE_URL\` secret is set and correct" >> $GITHUB_STEP_SUMMARY
            echo "2. Check if API server is running" >> $GITHUB_STEP_SUMMARY
            echo "3. Verify network connectivity from GitHub Actions runner" >> $GITHUB_STEP_SUMMARY
            echo "4. Review API logs for errors" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**If authentication failed:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Verify \`EXTRATO_API_TOKEN\` secret is set correctly" >> $GITHUB_STEP_SUMMARY
            echo "2. Ensure token is a valid service account JWT (not expired)" >> $GITHUB_STEP_SUMMARY
            echo "3. Check token has admin/service account role" >> $GITHUB_STEP_SUMMARY
            echo "4. Regenerate token if needed: \`python scripts/generate_service_token.py\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Artifacts Available:" >> $GITHUB_STEP_SUMMARY
          echo "- Response files: \`extrato-api-responses\` (when workflow fails)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*This is the GitHub Actions workflow safety net. Primary automation runs via APScheduler in the backend.*" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Monthly Extrato Generation Failed - ${{ steps.setup.outputs.month }}/${{ steps.setup.outputs.year }}`,
              body: `## Failure Report
              
              **Workflow Run**: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              **Triggered**: ${{ github.event_name }}
              **Target Period**: ${{ steps.setup.outputs.month }}/${{ steps.setup.outputs.year }}
              **HTTP Status**: ${{ steps.trigger.outputs.status }}
              
              ### Next Steps
              
              1. Check [workflow logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              2. Download the \`extrato-api-response\` artifact for full response details
              3. Verify APScheduler job status in production logs
              4. Check \`EXTRATO_REQUIRE_BACKUP\` environment variable
              5. Manually trigger generation if needed
              
              ### Manual Trigger
              
              \`\`\`bash
              # From backend container
              python scripts/run_atomic_extrato.py --month ${{ steps.setup.outputs.month }} --year ${{ steps.setup.outputs.year }}
              \`\`\`
              
              ### Debug curl command
              
              \`\`\`bash
              curl -v -X POST "${{ secrets.EXTRATO_API_BASE_URL }}/api/extrato/generate_service" \\
                -H "Content-Type: application/json" \\
                -H "Authorization: Bearer ${{ secrets.EXTRATO_API_TOKEN }}" \\
                -d '{"month": ${{ steps.setup.outputs.month }}, "year": ${{ steps.setup.outputs.year }}, "force": false}'
              \`\`\`
              
              ---
              *Auto-created by Monthly Extrato Backup Safety Net workflow*
              `,
              labels: ['automation', 'extrato', 'urgent']
            })
