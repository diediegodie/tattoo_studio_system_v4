name: Keep App Alive (Business Hours)

# This workflow keeps the Render-hosted app responsive during business hours
# by preventing the free tier from spinning down due to inactivity.
# 
# Schedule: Tuesday to Saturday, 10:00‚Äì19:00 S√£o Paulo time (UTC-3)
# Frequency: Every 14 minutes during business hours
# Target: /api/health (lightweight, always 200, no DB)
#
# Why this works:
# - Render free tier spins down after 15 minutes of inactivity
# - Pinging every 14 minutes keeps the instance warm with minimal margin
# - Using /api/health minimizes resource usage (no DB queries)
# - Neon DB may still sleep (5 min inactivity), but app stays ready
#
# Resource optimization:
# - Only runs during configured business hours
# - Uses lightweight endpoint to minimize compute
# - Single curl request per execution (fast, efficient)

on:
  schedule:
    - cron: '0,14,28,42,56 13 * * 1-6' # 10:00,10:14,10:28,10:42,10:56 BRT -> 13:00-13:56 UTC
    - cron: '10,24,38,52 14 * * 1-6'    # 11:10,11:24,11:38,11:52 BRT -> 14:10-14:52 UTC
    - cron: '6,20,34,48 15 * * 1-6'     # 12:06,12:20,12:34,12:48 BRT -> 15:06-15:48 UTC
    - cron: '2,16,30,44,58 16 * * 1-6'  # 13:02,13:16,...,13:58 BRT -> 16:02-16:58 UTC
    - cron: '12,26,40,54 17 * * 1-6'    # 14:12,...,14:54 BRT -> 17:12-17:54 UTC
    - cron: '8,22,36,50 18 * * 1-6'     # 15:08,...,15:50 BRT -> 18:08-18:50 UTC
    - cron: '4,18,32,46 19 * * 1-6'     # 16:04,...,16:46 BRT -> 19:04-19:46 UTC
    - cron: '0,14,28,42,56 20 * * 1-6'  # 17:00,...,17:56 BRT -> 20:00-20:56 UTC
    - cron: '10,24,38,52 21 * * 1-6'    # 18:10,18:24,18:38,18:52 BRT -> 21:10-21:52 UTC

  workflow_dispatch:

jobs:
  ping-app:
    name: Ping Render App
    runs-on: ubuntu-latest
    timeout-minutes: 5  # ‚Üê Aumentado para dar tempo do Render acordar
    steps:
      - name: Get current time (BRT)
        id: time
        run: |
          echo "utc_time=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          echo "brt_time=$(TZ='America/Sao_Paulo' date +'%Y-%m-%d %H:%M:%S BRT')" >> $GITHUB_OUTPUT
      
      - name: Ping /api/health endpoint
        run: |
          echo "üè• Pinging health endpoint at ${{ steps.time.outputs.brt_time }}"
          
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            --connect-timeout 60 \
            --max-time 180 \
            --retry 3 \
            --retry-delay 10 \
            https://alma-negra.onrender.com/api/health)
          
          if [ "$response" = "200" ]; then
            echo "‚úÖ App is alive (HTTP $response)"
          else
            echo "‚ö†Ô∏è  Unexpected response: HTTP $response"
            exit 1
          fi
      
      - name: Log execution
        if: always()
        run: |
          echo "Execution completed at ${{ steps.time.outputs.utc_time }}"
          echo "Local time: ${{ steps.time.outputs.brt_time }}"

# Best practices and recommendations:
#
# 1. ENDPOINT CHOICE:
#    - Current: /api/health (lightweight, no DB, fastest)
#    - Alternative: /ready (includes DB ping, keeps Neon awake but uses more resources)
#    - Recommendation: Stick with /api/health unless you need guaranteed DB warmth
#
# 2. FREQUENCY:
#    - Current: Every 10 minutes
#    - Render timeout: 15 minutes
#    - Safety margin: 5 minutes (adequate)
#    - Increasing frequency (e.g., every 5 min) won't significantly improve UX
#
# 3. FREE TIER CONSIDERATIONS:
#    GitHub Actions:
#    - Free tier: 2,000 minutes/month for private repos, unlimited for public
#    - This workflow: ~54 runs/day √ó 5 days = 270 runs/week = ~1,080 runs/month
#    - Time per run: ~30 seconds = 540 minutes/month (well within limits)
#    
#    Render:
#    - Free tier: 750 hours/month (31.25 days)
#    - Keeping alive 9 hours/day √ó 5 days/week √ó 4.3 weeks = ~193 hours/month (safe)
#    
#    Neon:
#    - Free tier: Active time limits vary by plan
#    - /api/health doesn't wake Neon, so DB stays asleep when not needed
#    - First real user request may still see Neon cold start (~2-5 seconds)
#
# 4. TO KEEP BOTH APP AND DB WARM:
#    If you need to eliminate ALL cold starts (including Neon), change the endpoint:
#    
#    Replace:
#      https://alma-negra.onrender.com/api/health
#    
#    With:
#      https://alma-negra.onrender.com/ready
#    
#    Trade-off: Higher resource usage, but guaranteed warm DB on user arrival
#
# 5. MONITORING:
#    - Check workflow runs in GitHub Actions tab
#    - Look for failed runs (may indicate app issues)
#    - Review Render logs to confirm pings are arriving
#    - Monitor Render/Neon usage to stay within free tier limits
#
# 6. ADJUST SCHEDULE IF NEEDED:
#    To modify business hours, adjust cron expressions:
#    - Earlier start: decrease the starting hour in UTC (13-X)
#    - Later end: increase the ending hour in UTC (X-22)
#    - Different days: change day-of-week numbers (0=Sunday, 6=Saturday)
#    - More frequent: change */10 to */5 (every 5 minutes)
#
# 7. SECURITY NOTE:
#    - No secrets required for public health endpoints
#    - If you add authentication in the future, use GitHub Secrets
#    - Example: ${{ secrets.HEALTH_CHECK_TOKEN }}
