{% set page_title = 'Alma Negra - Search Results' %}
{% include 'partials/_head.html' %}

{% include 'partials/_flash_messages.html' %}

<!-- Header -->
<header id="header">
    <a href="#" class="logo"><strong>Sistema</strong> de Gerenciamento</a>
    {% if current_user.is_authenticated %}
    <div class="user-info header-controls">
        {% if current_user.avatar_url %}
        <img src="{{ current_user.avatar_url }}" alt="Avatar" class="user-avatar">
        {% endif %}
        <span>Olá, {{ current_user.name }}!</span>
        <a href="{{ url_for('logout') }}" class="button">Sair</a>
    </div>
    {% endif %}
</header>

<!-- Search Results Header -->
<section>
    <h2>Resultados da Busca</h2>
    <p><strong>Consulta:</strong> "{{ query }}"</p>
    <p><strong>Total de resultados:</strong> {{ total_results }}</p>

    {% if error %}
    <div class="flash-message error">{{ error }}</div>
    {% endif %}
</section>

<!-- Results -->
{% if total_results > 0 %}

<!-- Unified Results (All entities sorted by date) -->
{% if unified_results %}
<section class="result-group">
    <h3>Todos os Resultados ({{ unified_results|length }}) - Ordenados por Data</h3>
    {% for result in unified_results %}
    <div class="search-result">
        <h4>{{ result.entity_type }} #{{ result.id }}</h4>
        {% if result.data %}
        <p><strong>Data:</strong> {{ result.data }}</p>
        {% endif %}
        {% if result.cliente_name %}
        <p><strong>Cliente:</strong> {{ result.cliente_name }}</p>
        {% endif %}
        {% if result.artista_name %}
        <p><strong>Artista:</strong> {{ result.artista_name }}</p>
        {% elif result.created_by_name %}
        <p><strong>Criado por:</strong> {{ result.created_by_name }}</p>
        {% endif %}
        {% if result.valor %}
        <p><strong>Valor:</strong> {{ format_currency(result.valor) }}</p>
        {% endif %}
        {% if result.nome %}
        <p><strong>Nome:</strong> {{ result.nome }}</p>
        {% endif %}
        {% if result.descricao %}
        <p><strong>Descrição:</strong> {{ result.descricao }}</p>
        {% endif %}
        {% if result.observacoes %}
        <p><strong>Observações:</strong> {{ result.observacoes }}</p>
        {% endif %}
        {% if result.status %}
        <p><strong>Status:</strong> {{ result.status }}</p>
        {% endif %}
        {% if result.forma_pagamento %}
        <p><strong>Forma de Pagamento:</strong> {{ result.forma_pagamento }}</p>
        {% endif %}
        {% if result.percentual %}
        <p><strong>Percentual:</strong> {{ "%.2f"|format(result.percentual) }}%</p>
        {% endif %}
        {% if result.quantity %}
        <p><strong>Quantidade:</strong> {{ result.quantity }}</p>
        {% endif %}
        <p><strong>Fonte:</strong> {{ result.source|title }}</p>
        {% if result.source == 'pagamento' or result.source == 'sessao' %}
        <p><a href="{{ url_for('financeiro.financeiro_home') }}" class="edit-link">Ver no Sistema</a>
        </p>
        {% elif result.source == 'inventory' %}
        <p><a href="{{ url_for('estoque') }}" class="edit-link">Ver no Estoque</a></p>
        {% else %}
        <p><a href="{{ url_for('index') }}" class="edit-link">Ver no Sistema</a></p>
        {% endif %}
    </div>
    {% endfor %}
</section>

<hr class="hr-separator">

<h3>Resultados por Categoria</h3>
{% endif %}

<!-- Pagamentos -->
{% if results.pagamentos %}
<section class="result-group">
    <h3>Pagamentos ({{ results.pagamentos|length }})</h3>
    {% for pagamento in results.pagamentos %}
    <div class="search-result">
        <h4>Pagamento #{{ pagamento.id }}</h4>
        <p><strong>Data:</strong> {{ pagamento.data }}</p>
        <p><strong>Cliente:</strong> {{ pagamento.cliente_name }}</p>
        <p><strong>Artista:</strong> {{ pagamento.artista_name }}</p>
        <p><strong>Valor:</strong> {{ format_currency(pagamento.valor) }}</p>
        <p><strong>Forma de Pagamento:</strong> {{ pagamento.forma_pagamento }}</p>
        {% if pagamento.observacoes %}
        <p><strong>Observações:</strong> {{ pagamento.observacoes }}</p>
        {% endif %}
        <p><a href="{{ url_for('financeiro.financeiro_home') }}" class="edit-link">Ver no Financeiro</a>
        </p>
    </div>
    {% endfor %}
</section>
{% endif %}

<!-- Sessões -->
{% if results.sessoes %}
<section class="result-group">
    <h3>Sessões ({{ results.sessoes|length }})</h3>
    {% for sessao in results.sessoes %}
    <div class="search-result">
        <h4>Sessão #{{ sessao.id }}</h4>
        <p><strong>Data:</strong> {{ sessao.data }}</p>
        <p><strong>Cliente:</strong> {{ sessao.cliente_name }}</p>
        <p><strong>Artista:</strong> {{ sessao.artista_name }}</p>
        <p><strong>Valor:</strong> {{ format_currency(sessao.valor) }}</p>
        <p><strong>Status:</strong> {{ sessao.status }}</p>
        {% if sessao.observacoes %}
        <p><strong>Observações:</strong> {{ sessao.observacoes }}</p>
        {% endif %}
        <p><a href="{{ url_for('sessoes.list_sessoes') }}" class="edit-link">Ver nas Sessões</a></p>
    </div>
    {% endfor %}
</section>
{% endif %}

<!-- Comissões -->
{% if results.comissoes %}
<section class="result-group">
    <h3>Comissões ({{ results.comissoes|length }})</h3>
    {% for comissao in results.comissoes %}
    <div class="search-result">
        <h4>Comissão #{{ comissao.id }}</h4>
        <p><strong>Artista:</strong> {{ comissao.artista_name }}</p>
        <p><strong>Percentual:</strong> {{ "%.2f"|format(comissao.percentual) }}%</p>
        <p><strong>Valor:</strong> {{ format_currency(comissao.valor) }}</p>
        {% if comissao.observacoes %}
        <p><strong>Observações:</strong> {{ comissao.observacoes }}</p>
        {% endif %}
        <p><a href="{{ url_for('financeiro.financeiro_home') }}" class="edit-link">Ver no Financeiro</a>
        </p>
    </div>
    {% endfor %}
</section>
{% endif %}

<!-- Extratos -->
{% if results.extratos %}
<section class="result-group">
    <h3>Extratos ({{ results.extratos|length }})</h3>
    {% for extrato in results.extratos %}
    <div class="search-result">
        <h4>Extrato {{ extrato.mes }}/{{ extrato.ano }}</h4>
        <p><strong>Encontrados:</strong> {{ extrato.matches|length }} matches</p>
        <p><a href="{{ url_for('extrato') }}" class="edit-link">Ver Extrato</a></p>
    </div>
    {% endfor %}
</section>
{% endif %}

<!-- Gastos -->
{% if results.gastos %}
<section class="result-group">
    <h3>Gastos ({{ results.gastos|length }})</h3>
    {% for gasto in results.gastos %}
    <div class="search-result">
        <h4>Gasto #{{ gasto.id }}</h4>
        <p><strong>Data:</strong> {{ gasto.data }}</p>
        <p><strong>Descrição:</strong> {{ gasto.descricao }}</p>
        <p><strong>Valor:</strong> {{ format_currency(gasto.valor) }}</p>
        <p><strong>Forma de Pagamento:</strong> {{ gasto.forma_pagamento }}</p>
        <p><strong>Criado por:</strong> {{ gasto.created_by_name }}</p>
        <p><a href="{{ url_for('financeiro.financeiro_home') }}" class="edit-link">Ver no Financeiro</a>
        </p>
    </div>
    {% endfor %}
</section>
{% endif %}

<!-- Estoque -->
{% if results.inventory %}
<section class="result-group">
    <h3>Estoque ({{ results.inventory|length }})</h3>
    {% for item in results.inventory %}
    <div class="search-result">
        <h4>{{ item.nome }}</h4>
        <p><strong>Quantidade:</strong> {{ item.quantidade }}</p>
        {% if item.category %}
        <p><strong>Categoria:</strong> {{ item.category }}</p>
        {% endif %}
        {% if item.unit_price %}
        <p><strong>Preço Unitário:</strong> {{ format_currency(item.unit_price) }}</p>
        {% endif %}
        {% if item.supplier %}
        <p><strong>Fornecedor:</strong> {{ item.supplier }}</p>
        {% endif %}
        {% if item.observacoes %}
        <p><strong>Observações:</strong> {{ item.observacoes }}</p>
        {% endif %}
        <p><a href="{{ url_for('estoque') }}" class="edit-link">Ver no Estoque</a></p>
    </div>
    {% endfor %}
</section>
{% endif %}

{% else %}
<section class="no-results">
    <h3>Nenhum resultado encontrado</h3>
    <p>Tente uma busca diferente ou verifique a ortografia.</p>
    <p><a href="{{ url_for('index') }}" class="edit-link">Voltar ao início</a></p>
</section>
{% endif %}

</div>
</div>

<!-- Sidebar -->
{% include 'partials/_sidebar.html' %}

</div>

{% include 'partials/_base_scripts.html' %}

<!-- Search Highlighting Script -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchQuery = "{{ query | lower }}";
        const tokens = searchQuery.split(/\s+/).filter(t => t.length > 0);

        function highlightElement(element) {
            element.childNodes.forEach(node => {
                if (node.nodeType === Node.TEXT_NODE) {
                    // Skip text inside <strong> tags (labels)
                    if (node.parentNode.tagName === 'STRONG') return;
                    let text = node.textContent;
                    let hasChanges = false;
                    tokens.forEach(token => {
                        const escapedToken = token.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        const regex = new RegExp('(' + escapedToken + ')', 'gi');
                        if (regex.test(text)) {
                            text = text.replace(regex, '<mark>$1</mark>');
                            hasChanges = true;
                        }
                    });
                    if (hasChanges) {
                        const span = document.createElement('span');
                        span.innerHTML = text;
                        node.parentNode.replaceChild(span, node);
                    }
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    highlightElement(node);
                }
            });
        }

        // Highlight in all result paragraphs
        document.querySelectorAll('.search-result p').forEach(p => {
            highlightElement(p);
        });
    });
</script>

</body>

</html>