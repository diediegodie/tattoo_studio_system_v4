{% set page_title = 'Financeiro' %}
{% include 'partials/_head.html' %}

<body class="is-preload">
    {% include 'partials/_flash_messages.html' %}
    <div id="wrapper">
        <div id="main">
            <div class="inner">
                <!-- Template selects for edit modal (hidden, reuse server-rendered options) -->
                <div id="template-selects" class="hidden">
                    <select id="tmpl_cliente_select">
                        <option value="">Selecione...</option>
                        {% for client in clients %}
                        <option value="{{ client.id }}">{{ client.name }}</option>
                        {% endfor %}
                    </select>
                    <select id="tmpl_artista_select">
                        <option value="">Selecione...</option>
                        {% for artist in artists %}
                        <option value="{{ artist.id }}">{{ artist.name }}</option>
                        {% endfor %}
                    </select>
                    {% include 'partials/_forma_pagamento_select.html' %}
                </div>

                <!-- Header -->
                <header id="header">
                    <a href="#" class="logo"><strong>Gerenciamento</strong> de finanças</a>
                </header>

                <!-- Content -->
                <section>
                    <header class="main">
                        <h1>Financeiro</h1>
                    </header>
                    <div class="mb-1">
                        <a href="{{ url_for('registrar_pagamento') }}" id="add-item-btn"
                            class="button primary">Registrar Pagamento</a>
                    </div>
                    <section>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Cliente</th>
                                        <th>Artista</th>
                                        <th>Valor</th>
                                        <th>Forma de pagamento</th>
                                        <th>Observações</th>
                                        <th>Opções</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {# Client is optional - display "Não informado" when missing (consistent with
                                    registration form) #}
                                    {% for pagamento in pagamentos %}
                                    <tr data-id="{{ pagamento.id }}">
                                        <td>{{ format_date_br(pagamento.data) }}</td>
                                        <td>{{ format_client_name(pagamento.cliente) }}</td>
                                        <td>{{ safe_attr(pagamento.artista, 'name') }}</td>
                                        <td>{{ format_currency(pagamento.valor) }}</td>
                                        <td>{{ pagamento.forma_pagamento or '' }}</td>
                                        <td>{{ pagamento.observacoes or '' }}</td>
                                        <td>
                                            <button class="button small options-btn"
                                                onclick="toggleOptions(this)">Opções</button>
                                            <span class="options-actions">
                                                <button class="button small edit-pagamento-btn"
                                                    data-id="{{ pagamento.id }}">Editar</button>
                                                <form method="POST"
                                                    action="{{ url_for('financeiro.delete_pagamento', pagamento_id=pagamento.id) }}"
                                                    style="display:inline;">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                                    <button type="submit" class="button small delete-pagamento-btn"
                                                        data-id="{{ pagamento.id }}">Excluir</button>
                                                </form>
                                            </span>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="8">Nenhum pagamento registrado.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </section>

                </section>
            </div>
        </div>
        {% include 'partials/_sidebar.html' %}
    </div>

    <script>
        window.FINANCEIRO_API_BASE = "{{ url_for('financeiro.api_list_pagamentos') }}";
    </script>
    {% include 'partials/_base_scripts.html' %}
    <script src="{{ url_for('static', filename='js/financeiro.js', v=config.get('GIT_SHA','')) }}"></script>

</body>

</html>