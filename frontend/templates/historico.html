{% set page_title = 'Histórico' %}
{% include 'partials/_head.html' %}

<body id="historico-page" class="is-preload">

    <!-- Wrapper -->
    <div id="wrapper">

        <!-- Main -->
        <div id="main">
            <div class="inner">

                <!-- Header -->
                <header id="header">
                    <a href="#" class="logo"><strong>Histórico</strong> geral</a>
                </header>

                <!-- Content -->
                <section>
                    <header class="main">
                        <h1>Histórico</h1>
                    </header>

                    <!-- Template selects for edit modal (hidden, reuse server-rendered options) -->
                    <div id="template-selects" class="hidden">
                        <select id="tmpl_cliente_select">
                            <option value="">Selecione...</option>
                            {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.name }}</option>
                            {% endfor %}
                        </select>
                        <select id="tmpl_artista_select">
                            <option value="">Selecione...</option>
                            {% for artist in artists %}
                            <option value="{{ artist.id }}">{{ artist.name }}</option>
                            {% endfor %}
                        </select>
                        {% include 'partials/_forma_pagamento_select.html' %}
                    </div>

                    <section>
                        <header class="major">
                            <h2>Pagamentos</h2>
                        </header>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Cliente</th>
                                        <th>Artista</th>
                                        <th>Valor</th>
                                        <th>Forma de pagamento</th>
                                        <th>Observações</th>
                                        <th>Opções</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {# Client is optional - display "Não informado" when missing (consistent with
                                    registration form) #}
                                    {% for p in pagamentos %}
                                    <tr data-id="{{ p.id }}">
                                        <td>{{ p.data.strftime('%d/%m/%Y') if p.data else '' }}</td>
                                        <td>{{ p.cliente.name if p.cliente else 'Não informado' }}</td>
                                        <td>{{ p.artista.name if p.artista else '' }}</td>
                                        <td>{{ 'R$ %.2f' % p.valor if p.valor is not none else '' }}</td>

                                        <td>{{ p.forma_pagamento }}</td>
                                        <td>{{ p.observacoes or '' }}</td>
                                        <td>
                                            <button type="button" class="button small options-btn"
                                                onclick="toggleOptions(this)">Opções</button>
                                            <span class="options-actions">
                                                <button class="button small edit-pagamento-btn btn-margin-right"
                                                    data-id="{{ p.id }}">Editar</button>
                                                <button class="button small delete-pagamento-btn"
                                                    data-id="{{ p.id }}">Excluir</button>
                                            </span>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="7">Nenhum pagamento encontrado.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <header class="major">
                            <h2>Comissões</h2>
                        </header>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Artista</th>
                                        <th>Cliente</th>
                                        <th>Valor total</th>
                                        <th>Comissão</th>
                                        <th>Observações</th>
                                        <th>Opções</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {# Client is optional - display "Não informado" when missing (consistent with
                                    registration form) #}
                                    {% for c in comissoes %}
                                    <tr data-id="com-{{ c.id }}">
                                        <td>{{ c.created_at.strftime('%d/%m/%Y') if c.created_at else '' }}</td>
                                        <td>{{ c.artista.name if c.artista else '' }}</td>
                                        <td>{{ c.pagamento.cliente.name if c.pagamento and c.pagamento.cliente else 'Não
                                            informado'
                                            }}</td>
                                        <td>{{ 'R$ %.2f' % c.pagamento.valor if c.pagamento and c.pagamento.valor is not
                                            none else '' }}</td>
                                        <td>{{ 'R$ %.2f' % c.valor }}</td>
                                        <td>{{ c.observacoes or '' }}</td>
                                        <td>
                                            <button type="button" class="button small options-btn"
                                                onclick="toggleOptions(this)">Opções</button>
                                            <span class="options-actions">
                                                <button class="button small edit-comissao-btn btn-margin-right"
                                                    data-id="{{ c.id }}">Editar</button>
                                                <button class="button small delete-comissao-btn"
                                                    data-id="{{ c.id }}">Excluir</button>
                                            </span>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="7">Nenhuma comissão encontrada.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <header class="major">
                            <h2>Sessões realizadas</h2>
                        </header>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Cliente</th>
                                        <th>Artista</th>
                                        <th>Valor</th>
                                        <th>Observações</th>
                                        <th>Opções</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {# Client is optional - display "Não informado" when missing (consistent with
                                    registration form) #}
                                    {% for s in sessoes %}
                                    <tr data-id="sess-{{ s.id }}">
                                        <td>{{ s.data.strftime('%d/%m/%Y') if s.data else '' }}</td>
                                        <td>{{ s.cliente.name if s.cliente else 'Não informado' }}</td>
                                        <td>{{ s.artista.name if s.artista else '' }}</td>
                                        <td>{{ 'R$ %.2f' % s.valor if s.valor is not none else '' }}</td>
                                        <td>{{ s.observacoes or '' }}</td>
                                        <td>
                                            <button type="button" class="button small options-btn"
                                                onclick="toggleOptions(this)">Opções</button>
                                            <span class="options-actions">
                                                <button class="button small edit-sessao-btn btn-margin-right"
                                                    data-id="{{ s.id }}">Editar</button>
                                                <button class="button small delete-sessao-btn"
                                                    data-id="{{ s.id }}">Excluir</button>
                                            </span>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="6">Nenhuma sessão encontrada.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <!-- Monthly Totals Section -->
                    {% if has_current_entries and current_totals %}
                    <section>

                        {% if current_totals['por_artista'] %}
                        <header class="major">
                            <h3>Comissões por Artista</h3>
                        </header>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Artista</th>
                                        <th>Receita Gerada</th>
                                        <th>Comissão</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for artista in current_totals['por_artista'] %}
                                    <tr>
                                        <td>{{ artista['artista'] }}</td>
                                        <td>R$ {{ '%.2f' % artista['receita'] }}</td>
                                        <td>R$ {{ '%.2f' % artista['comissao'] }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}

                        {% if current_totals['por_forma_pagamento'] %}
                        <header class="major">
                            <h3>Receita por Forma de Pagamento</h3>
                        </header>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Forma de Pagamento</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for forma in current_totals['por_forma_pagamento'] %}
                                    <tr>
                                        <td>{{ forma['forma'] }}</td>
                                        <td>R$ {{ '%.2f' % forma['total'] }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}

                        {% if gastos_json and gastos_json|length > 0 %}
                        <header class="major">
                            <h3>Gastos do Mês</h3>
                        </header>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Valor</th>
                                        <th>Descrição</th>
                                        <th>Forma de Pagamento</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for g in gastos_json %}
                                    <tr>
                                        <td>{{ g.data[:10] if g.data else '' }}</td>
                                        <td>R$ {{ '%.2f' % (g.valor or 0) }}</td>
                                        <td>{{ g.descricao or '' }}</td>
                                        <td>{{ g.forma_pagamento or '' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}
                    </section>
                    {% endif %}

                    <!-- Moved Monthly Totals Section -->
                    {% if has_current_entries and current_totals %}
                    <section>
                        <header class="major">
                            <h2>Totais do Mês Atual</h2>
                        </header>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Métrica</th>
                                        <th>Valor</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Receita Total (Bruta)</td>
                                        <td>R$ {{ '%.2f' % current_totals['receita_total'] }}</td>
                                    </tr>
                                    <tr>
                                        <td>Comissões Totais</td>
                                        <td>R$ {{ '%.2f' % current_totals['comissoes_total'] }}</td>
                                    </tr>
                                    <tr>
                                        <td>Despesas (Gastos)</td>
                                        <td>R$ {{ '%.2f' % current_totals.get('despesas_total', 0) }}</td>
                                    </tr>
                                    {# <tr>
                                        <td>Saldo (Receita - Despesas)</td>
                                        <td>R$ {{ '%.2f' % current_totals.get('saldo', (current_totals['receita_total']
                                            - current_totals['comissoes_total'])) }}</td>
                                    </tr> #}
                                    <tr>
                                        <td>Receita Líquida (Bruta - Comissões - Gastos)</td>
                                        <td>R$ {{ '%.2f' % current_totals['receita_liquida'] }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </section>
                    {% endif %}

                </section>

            </div>
        </div>

        {% include 'partials/_sidebar.html' %}

    </div>

    {% include 'partials/_base_scripts.html' %}
    <!-- Utility scripts required by financeiro/sessoes/historico -->
    <script src="{{ url_for('static', filename='js/utils/dom-helpers.js') }}"></script>
    <script src="{{ url_for('static', filename='js/utils/resource-client.js') }}"></script>
    <script src="{{ url_for('static', filename='js/financeiro.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sessoes.js') }}"></script>
    <script src="{{ url_for('static', filename='js/historico.js') }}"></script>

</body>

</html>